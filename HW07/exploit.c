#include <unistd.h>
#include <signal.h>
#include <sys/wait.h>
#include <sys/types.h>

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

const char *target_host = "localhost";
const char *target_port = "8080";

int main(int argc, char *argv[])
{
    //Prepare pipe
    int pipefd[2];
    if (pipe(pipefd) == -1)
    {
        exit(2);
    }
    //process fork
    pid_t forkpid = fork();
    if (forkpid == 0)
    {
        if (dup2(pipefd[1], STDOUT_FILENO) != STDOUT_FILENO)
            exit(2);
        if (close(pipefd[1]))
            exit(2);
        if (dup2(pipefd[0], STDIN_FILENO) != STDIN_FILENO)
            exit(2);
        if (close(pipefd[0]))
            exit(2);
        if (execl("/usr/bin/nc", "nc", target_host, target_port, NULL))
            exit(2);
    }
    else if (forkpid == -1)
    {
        exit(2);
    }

    if (dup2(pipefd[1], STDIN_FILENO) != STDIN_FILENO)
        exit(2);
    if (close(pipefd[1]))
        exit(2);
    if (dup2(pipefd[0], STDOUT_FILENO) != STDOUT_FILENO)
        exit(2);
    if (close(pipefd[0]))
        exit(2);

    char *cmd = "GET / HTTP/1.0\r\n\r\n";
    printf("%s", cmd);
    fflush(stdout);

    char *answer = malloc(4 * 1024 * 1024 + 1);
    int ans_len = read(pipefd[1], answer, 4 * 1024 * 1024);
    fprintf(stderr, "Read answer, lenght %d\n", ans_len);
    if (ans_len < 0)
        exit(2);

    answer[ans_len] = '\0';

    printf("%s\n", answer);
    free(answer);
    int forkstat;
    pid_t waitfork = waitpid(forkpid, &forkstat, 0);
    if (waitfork != forkpid)
    {
        exit(2);
    }
    if (close(pipefd[1]))
        exit(2);

    return 0;
}
